name: MinderaPeople Android

on:
  push:
    branches: [ main, release, develop ]
  pull_request:
    branches: [ main, release, develop ]

# Ensures that only one deploy task per branch/environment will run at a time
concurrency:
  group: android-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: macOS-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup JDK
      uses: actions/setup-java@v3
      with:
        distribution: 'adopt'
        java-version: 17

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2

    - name: Build Android app
      run: ./gradlew android:assembleDebug

  test:
    needs: build
    runs-on: macOS-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup JDK
      uses: actions/setup-java@v3
      with:
        distribution: 'adopt'
        java-version: 17

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2

    - name: Run core Unit Tests
      run: ./gradlew core:testDebugUnitTest

    - name: Run android Unit Tests
      run: ./gradlew android:testDebugUnitTest

  deploy:
    if: contains(fromJson('["refs/heads/develop", "refs/heads/release", "refs/heads/main"]'), github.ref)
    needs: test
    runs-on: macOS-latest

    environment: firebase-app-distribution

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Setup JDK
      uses: actions/setup-java@v3
      with:
        distribution: 'adopt'
        java-version: 17

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2

    - name: Setup Environment
      env:
        FB_DIST: ${{ secrets.APPS_FIREBASE_DISTRIBUTION }}
      run: |
        echo $FB_DIST > $RUNNER_TEMP/fb-dist.json
        echo "FB_DIST_FILE=$RUNNER_TEMP/fb-dist.json" >> $GITHUB_ENV
        echo "VERSION_CODE=$(git rev-list --count $GITHUB_REF)" >> $GITHUB_ENV
        ./gradlew --stop

    - name: Build and Publish Alpha
      if: github.ref == 'refs/heads/develop'
      run: ./gradlew android:assembleAlpha android:appDistributionUploadAlpha

    - name: Build and Publish Beta
      if: github.ref == 'refs/heads/release'
      run: ./gradlew android:assembleBeta android:appDistributionUploadBeta

    - name: Build and Publish Release
      if: github.ref == 'refs/heads/main'
      env:
        KEYSTORE: ${{ secrets.RELEASE_KEYSTORE }}
        KEYSTORE_PASSPHRASE: ${{ secrets.RELEASE_KEYSTORE_PASS }}
        RK_STORE_PASS: ${{ secrets.RK_STORE_PASS }}
        RK_KEY_ALIAS: ${{ secrets.RK_KEY_ALIAS }}
        RK_KEY_PASS: ${{ secrets.RK_KEY_PASS }}
      run: |
        echo $KEYSTORE > release.keystore.asc
        gpd -d --passphrase "$KEYSTORE_PASSPHRASE" --batch release.keystore.asc > $RUNNER_TEMP/release.keystore
        echo "RK_FILE=$RUNNER_TEMP/release.keystore" >> $GITHUB_ENV
        ./gradlew --stop
        ./gradlew android:assembleRelease android:appDistributionUploadRelease
